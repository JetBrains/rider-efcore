name: Deploy
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:
    branches: [ master ]

jobs:
  windows:
    runs-on: ubuntu-latest
    steps:
      - name: 📝 Fetch Sources
        uses: actions/checkout@v2

      - name: 🧐 Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@v1

      - name: 🛠 Setup JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: 11
          distribution: 'adopt'

      - name: 🛠 Setup .NET SDK
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: '6.0.x'

      - name: 🏗 Generate RD protocol data
        uses: gradle/gradle-build-action@v2
        with:
          arguments: rdgen

      - name: 🔍 Extract Version
        uses: madhead/read-java-properties@latest
        id: version
        with:
          file: gradle.properties
          property: PluginVersion
          default: 0.0.1

#       - name: 🚀 Publish Plugin
#         uses: gradle/gradle-build-action@v2
#         with:
#           arguments: buildPlugin -PPublishToken=${{ secrets.JB_PUBLISH_TOKEN }}

      - name: 🏗 Build Plugin for 2021.2
        uses: gradle/gradle-build-action@v2
        with:
          arguments: buildPlugin -PRiderSdkVersion=2021.2.0 -PProductVersion=2021.2

      - name: Rename intermediate plugin dist for 2021.2
        run: mv output/riderefcore-${{ steps.version.outputs.value }}.zip output/rider-212-efcore-${{ steps.version.outputs.value }}.zip

      - name: 🏗 Build Plugin for 2021.3 EAP 10
        uses: gradle/gradle-build-action@v2
        with:
          arguments: buildPlugin -PRiderSdkVersion=2021.3.0-eap10 -PProductVersion=2021.3-EAP10-SNAPSHOT

      - name: Rename intermediate plugin dist for 2021.3 EAP 10
        run: mv output/riderefcore-${{ steps.version.outputs.value }}.zip output/rider-213-efcore-${{ steps.version.outputs.value }}.zip

      - name: 🚀 Create Release
        uses: ncipollo/release-action@v1
        with:
          commit: ${GITHUB_REF##*/} # Branch name extracted from ref
          tag: v${{ steps.version.outputs.value }} # 'v' + version from gradle.properties
          draft: true
          artifacts: "output/*.zip"
          token: ${{ secrets.GITHUB_TOKEN }}
